<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Invoice Converter</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7fafc;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            color: #333;
        }

        .wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 90%;
            max-width: 1200px;
            padding: 20px;
            gap: 20px;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            width: 45%;  /* Increased width for form */
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #dc3545;
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input[type="number"] {
            padding: 12px;
            background-color: #f1f3f5;
            border-radius: 8px;
            border: 1px solid #ddd;
            color: #333;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        input[type="number"]:hover {
            background-color: #e2e6ea;
        }

        input[type="submit"] {
            background-color: #dc3545;
            color: #fff;
            font-size: 1.2rem;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        input[type="submit"]:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        input[type="submit"]:active {
            background-color: #bd2130;
            transform: translateY(0);
        }

        .pdf-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 50%;  /* Increased width for PDF viewer */
            height: 100%; /* Take up all the remaining height */
            max-height: 90vh;
            overflow: hidden;
        }

        .pdf-canvas-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigation button {
            padding: 10px;
            font-size: 1rem;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .navigation button:hover {
            background-color: #c82333;
        }

        .navigation button:active {
            background-color: #bd2130;
        }

        /* Coordinates display */
        #cursor-position {
            margin-top: 10px;
            font-size: 1rem;
            color: #333;
            font-family: Arial, sans-serif;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 8px;
            width: 100%;
            text-align: center;
        }

        /* Button styling for select start/end */
        #selectBegin, #selectEnd {
            padding: 10px;
            font-size: 1rem;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        #selectBegin:hover, #selectEnd:hover {
            background-color: #138496;
        }

        #selectBegin:active, #selectEnd:active {
            background-color: #117a8b;
        }

        /* Active button colors */
        #selectBegin.active {
            background-color: #28a745;
        }

        #selectEnd.active {
            background-color: #007bff;
        }

        /* Instructions Section */
        .instructions {
            color: #888;
            font-size: 0.9rem;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <h1>Select start and end positions</h1>
            <form action="/select-positions" method="POST">
                <input id="startingPage" name="startingPage" type="number" placeholder="Starting page" required>
                <input id="startingY" name="startingY" type="number" placeholder="Initial Y value" required>
                <input id="endingPage" name="endingPage" type="number" placeholder="Final page" required>
                <input id="endingY" name="endingY" type="number" placeholder="Final Y value" required>
                <input type="submit" value="Enviar">
            </form>

            <!-- Select Begin and End Buttons -->
            <button id="selectBegin">Select Beginning</button>
            <button id="selectEnd">Select End</button>

            <!-- Instructions Section -->
            <div class="instructions">
                <p>Select the beginning and ending positions on the PDF. Click "Select Beginning" to mark the starting point, then click "Select End" to mark the end point. The form will automatically update with the selected positions. The start position is where the billing per service part starts. The end position is where the list of used products ends.</p>
            </div>
        </div>

        <!-- PDF Viewer Container -->
        <div class="pdf-container" id="pdf-container">
            <div class="pdf-canvas-container">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div class="navigation">
                <button id="prevPage">Previous</button>
                <span id="pageNum">Page 1</span>
                <button id="nextPage">Next</button>
            </div>
            <!-- Coordinates display -->
            <div id="cursor-position">Cursor Position: (0, 0)</div>
        </div>
    </div>

    <!-- Include PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        const url = 'static/pdfs/{{filename}}';  // Path to the PDF file

        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const pageNumDisplay = document.getElementById('pageNum');
        const pdfContainer = document.getElementById('pdf-container');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const cursorPositionDisplay = document.getElementById('cursor-position');
        const selectBeginButton = document.getElementById('selectBegin');
        const selectEndButton = document.getElementById('selectEnd');

        let pdfDoc = null;
        let currentPage = 1;

        let isSelectingBegin = true;
        selectBeginButton.classList.add('active');
        let isSelectingEnd = false;

        let beginPage = null;
        let beginY = null;
        let endPage = null;
        let endY = null;

        // Load PDF document using PDF.js when the page loads
        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            pdfDoc = pdf;
            renderPage(currentPage);
        });

        // Render PDF page
        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(function(page) {
                const scale = 1;
                const viewport = page.getViewport({ scale: scale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                page.render({
                    canvasContext: ctx,
                    viewport: viewport
                });

                pageNumDisplay.textContent = `Page ${pageNum}`;
            });
        }

        // Show previous page
        prevPageButton.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        });

        // Show next page
        nextPageButton.addEventListener('click', function() {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        });

        // Update cursor position on hover
        canvas.addEventListener('mousemove', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Adjust for the scale applied to the canvas
            const scale = 1;  // Change this scale if you modify the render scale
            const pdfX = x / scale;
            const pdfY = y / scale;

            cursorPositionDisplay.textContent = `Cursor Position: (${Math.round(pdfX * (canvas.width / canvas.clientWidth))}, ${Math.round(pdfY * (canvas.height / canvas.clientHeight))})`;

            // Update the form fields for start and end positions
            if (isSelectingBegin) {
                document.getElementById("startingPage").value = currentPage;
                document.getElementById("startingY").value = Math.round(pdfY * (canvas.height / canvas.clientHeight));
            }

            if (isSelectingEnd) {
                document.getElementById("endingPage").value = currentPage;
                document.getElementById("endingY").value = Math.round(pdfY * (canvas.height / canvas.clientHeight));
            }
        });


        // Handle Select Beginning
        selectBeginButton.addEventListener('click', function() {
            if (!isSelectingBegin) {
                isSelectingBegin = true;
                isSelectingEnd = false; // Disable end selection
                selectBeginButton.classList.add('active'); // Change color when active
                selectEndButton.classList.remove('active'); // Reset color for the end selection button
            } else {
                isSelectingBegin = false; // Disable selection after click
                selectBeginButton.classList.remove('active'); // Reset color for the beginning selection button
            }
        });

        // Handle Select End
        selectEndButton.addEventListener('click', function() {
            if (!isSelectingEnd) {
                isSelectingEnd = true;
                isSelectingBegin = false; // Disable beginning selection
                selectEndButton.classList.add('active'); // Change color when active
                selectBeginButton.classList.remove('active'); // Reset color for the beginning selection button
            } else {
                isSelectingEnd = false; // Disable selection after click
                selectEndButton.classList.remove('active'); // Reset color for the end selection button
            }
        });

        canvas.addEventListener("click", ()=> {
            if(isSelectingBegin){
                isSelectingBegin = false
                isSelectingEnd = true

                selectBeginButton.classList.remove('active');
                selectEndButton.classList.add('active');
            }else{
                isSelectingBegin = false
                isSelectingEnd = false

                selectBeginButton.classList.remove('active');
                selectEndButton.classList.remove('active');
            }
        });
    </script>
</body>
</html>
